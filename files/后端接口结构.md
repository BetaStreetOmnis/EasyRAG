# EasyRAG 后端接口结构

## 整体架构图

```
┌───────────────────────────────────────────────────────────────┐
│                        客户端 (前端/API调用方)                    │
└───────────────────────────────┬───────────────────────────────┘
                                │                               
                                ▼                               
┌───────────────────────────────────────────────────────────────┐
│                      REST API 接口层                           │
│                    (FastAPI/uvicorn)                          │
└───────────────────────────────┬───────────────────────────────┘
                                │
                                ▼
┌───────────────────────────────────────────────────────────────┐
│                          核心服务层                            │
│  ┌─────────────────┐        ┌────────────────┐                │
│  │   RAGService    │◄──────►│DocumentProcessor│                │
│  └────────┬────────┘        └─────────┬──────┘                │
│           │                           │                       │
│           ▼                           ▼                       │
│  ┌─────────────────┐        ┌────────────────┐                │
│  │  知识库管理模块   │        │  文档分块模块    │                │
│  └─────────────────┘        └────────────────┘                │
└──────────────────────────────┬────────────────────────────────┘
                               │
                               ▼
┌───────────────────────────────────────────────────────────────┐
│                          模型与存储层                           │
│  ┌─────────────────┐  ┌──────────────┐  ┌───────────────────┐  │
│  │ 向量数据库接口    │  │ 嵌入模型接口  │  │  LLM模型接口      │  │
│  └─────────────────┘  └──────────────┘  └───────────────────┘  │
└───────────────────────────────────────────────────────────────┘
```

## 接口分组与功能

### 1. 知识库管理接口

| 接口路径 | 方法 | 功能描述 |
|---------|------|---------|
| `/kb/create` | POST | 创建新的知识库 |
| `/kb/list` | GET | 获取所有知识库列表 |
| `/kb/info/{kb_name}` | GET | 获取指定知识库的信息 |
| `/kb/delete/{kb_name}` | DELETE | 删除指定的知识库 |

### 2. 文件管理接口

| 接口路径 | 方法 | 功能描述 |
|---------|------|---------|
| `/kb/upload` | POST | 上传文件到知识库 |
| `/kb/files/{kb_name}` | GET | 获取知识库中的文件列表 |
| `/kb/file/{kb_name}/{file_name}` | GET | 获取文件详情 |
| `/kb/file/{kb_name}/{file_name}` | DELETE | 删除知识库中的文件 |
| `/kb/replace_file` | POST | 替换知识库中的文件 |
| `/kb/set_importance` | POST | 设置文件的重要性系数 |

### 3. 文档处理接口

| 接口路径 | 方法 | 功能描述 |
|---------|------|---------|
| `/extract_text_from_file` | POST | 从文件中提取文本 |
| `/chunker/methods` | GET | 获取所有可用的分块方法 |
| `/kb/delete_documents` | POST | 根据条件删除知识库中的文档 |

### 4. 检索与对话接口

| 接口路径 | 方法 | 功能描述 |
|---------|------|---------|
| `/kb/search` | POST | 在知识库中搜索内容 |
| `/kb/chat` | POST | 与知识库进行对话 |
| `/kb/chat_stream` | POST | 与知识库进行流式对话 |

### 5. 任务管理接口

| 接口路径 | 方法 | 功能描述 |
|---------|------|---------|
| `/kb/progress/{task_id}` | GET | 获取任务处理进度 |

## 核心组件说明

### RAGService 类
负责知识库的创建、管理和检索，是系统的核心组件。主要功能包括：
- 知识库的CRUD操作
- 文档添加与检索
- 文件管理
- 与LLM交互进行知识增强对话

#### 知识库管理详细功能
1. **知识库创建**
   - 创建新的向量知识库
   - 配置向量维度和索引类型
   - 初始化元数据存储

2. **知识库查询**
   - 获取所有知识库列表
   - 获取知识库详细信息（包含文档数量、创建时间等）
   - 检查知识库是否存在

3. **知识库删除**
   - 删除知识库及其所有文档
   - 清理相关资源和索引

4. **知识库搜索**
   - 向量相似度检索
   - 结果重排序
   - 去重处理

5. **文档管理**
   - 添加文档到知识库
   - 删除知识库中的文档
   - 更新文档

6. **知识库对话**
   - 根据用户查询检索相关文档
   - 构建上下文增强提示
   - 调用LLM生成回答
   - 支持流式输出

### DocumentProcessor 类
负责文档的处理和分块，主要功能包括：
- 文本提取
- 文档分块
- 文档解析
- 进度跟踪回调

#### 文档管理详细功能
1. **文本提取**
   - 支持多种文件格式（PDF、DOCX、TXT、MD等）
   - 保留文档结构和格式
   - 处理特殊字符和编码

2. **文档分块**
   - 多种分块策略：
     - `text_semantic`: 基于语义的文本分块
     - `semantic`: 完全语义分块
     - `hierarchical`: 层次分块
     - `markdown_header`: 基于Markdown标题分块
     - `recursive_character`: 递归字符分块
     - `bm25`: 基于BM25算法分块
   - 自定义分块大小和重叠度
   - 智能处理段落和句子边界

3. **文件管理**
   - 临时文件处理
   - 文件上传与验证
   - 文件替换
   - 文件元数据管理

4. **进度跟踪**
   - 长时间运行任务的进度报告
   - 状态更新回调
   - 错误处理和恢复

### 数据模型
系统使用多个Pydantic模型定义API接口参数：
- `KnowledgeBaseCreate`: 知识库创建参数
- `SearchQuery`: 搜索查询参数
- `ChunkConfig`: 分块配置参数
- `ChatQuery`: 对话查询参数
- `ImportanceUpdate`: 文件重要性更新参数

## 系统特性

1. **异步处理**：使用FastAPI的异步特性处理并发请求
2. **进度跟踪**：长时间运行的任务（如文件上传）支持进度追踪
3. **流式响应**：支持大型语言模型的流式输出
4. **错误处理**：全面的异常捕获和处理机制
5. **临时文件管理**：安全地处理临时文件
6. **CORS支持**：支持跨域请求

## 部署配置

- **默认主机**: 0.0.0.0 (监听所有网络接口)
- **默认端口**: 8023

## 数据流说明

1. **文档上传流程**:
   - 客户端上传文件 → 临时存储 → 文本提取 → 文档分块 → 向量化 → 存储到知识库
   
2. **检索流程**:
   - 查询请求 → 向量化查询 → 相似度检索 → 可选重排序 → 返回结果
   
3. **对话流程**:
   - 用户问题 → 检索相关文档 → 构建提示 → LLM处理 → 返回答案

## 错误处理机制

系统采用多层错误处理机制：
1. 每个接口都有异常捕获
2. 详细的错误日志记录
3. 用户友好的错误消息
4. 任务状态追踪

## 知识库底层存储结构

知识库系统使用多个文件来管理向量数据、元数据和文件信息，主要包括以下几类文件：

### 核心存储文件

| 文件后缀 | 名称 | 功能描述 |
|--------|------|---------|
| `.index` | 向量索引文件 | 存储FAISS向量索引，包含所有文档的向量表示 |
| `.meta` | 元数据文件 | 存储向量对应的原始文本和元数据信息 |
| `.files.json` | 文件注册表 | 存储文件信息、版本和向量映射关系 |
| `.history.json` | 变更历史记录 | 记录所有文件和知识库的操作历史 |

### 文件注册表 (.files.json)

**功能作用**：
- 存储知识库中所有文件的元数据和状态信息
- 记录每个文件的当前状态、版本信息和向量映射关系
- 作为文档管理的核心数据结构

**数据结构**：
```json
{
  "_created_at": "2023-04-01T18:17:56.424263",
  "_last_updated": "2023-04-01T18:17:56.424263",
  "_file_count": 2,
  "_vector_count": 148,
  
  "示例文件.pdf": {
    "file_name": "示例文件.pdf",
    "file_path": "/path/to/file.pdf",
    "added_at": "2023-04-01T18:17:56.424263",
    "vector_count": 75,
    "last_updated": "2023-04-05T09:22:18.123456",
    "versions": [
      {
        "version": 1,
        "vector_count": 70,
        "vector_ids": [0, 1, 2, ..., 69],
        "created_at": "2023-04-01T18:17:56.424263"
      },
      {
        "version": 2,
        "vector_count": 75,
        "vector_ids": [148, 149, ..., 222],
        "created_at": "2023-04-05T09:22:18.123456"
      }
    ],
    "current_version": 2
  }
}
```

**主要字段说明**：
- `_created_at` - 知识库创建时间
- `_last_updated` - 最后更新时间
- `_file_count` - 文件总数
- `_vector_count` - 向量总数
- 每个文件条目包含：
  - 文件基本信息（名称、路径、添加时间）
  - 向量数量统计
  - 版本历史记录
  - 当前使用的版本

### 变更历史记录 (.history.json)

**功能作用**：
- 记录文件和知识库的所有变更历史
- 提供审计追踪和操作日志
- 支持版本回溯和变更分析

**数据结构**：
```json
[
  {
    "event_type": "file_added",
    "file_name": "示例文件.pdf",
    "timestamp": "2023-04-01 14:30:45",
    "data": {
      "vector_count": 70,
      "version": 1
    }
  },
  {
    "event_type": "file_replaced",
    "file_name": "示例文件.pdf",
    "timestamp": "2023-04-05 09:22:18",
    "data": {
      "old_version": 1,
      "new_version": 2,
      "vector_count": 75
    }
  }
]
```

**主要事件类型**：
- `file_added` - 文件添加
- `file_replaced` - 文件替换
- `file_deleted` - 文件删除
- `collection_created` - 知识库创建

### 两种文件的区别与关系

| 特性 | files.json | history.json |
|------|------------|--------------|
| **数据结构** | 字典/对象（键值对） | 数组/列表（事件序列） |
| **主要目的** | 存储当前状态 | 记录历史变更 |
| **更新频率** | 每次文件操作都更新 | 每次事件发生时追加 |
| **用途** | 文件管理和检索 | 审计追踪和历史记录 |
| **时态** | 当前状态 | 历史记录 |

这两个文件共同工作，提供了完整的文件管理功能：
- `files.json` 提供高效的当前状态查询和文件索引
- `history.json` 提供历史操作的完整记录和审计线索
- 系统可通过这两个文件实现文件版本管理、回溯和状态恢复

## 版本管理机制

EasyRAG支持文件级别的版本管理，主要通过以下机制实现：

1. **文件版本创建**：
   - 每次上传新文件时创建初始版本（version=1）
   - 替换文件时自动创建新版本（version递增）

2. **版本信息存储**：
   - 在files.json中记录每个版本的向量ID映射
   - 使用current_version标记当前使用的版本

3. **版本回溯**：
   - 支持通过API回溯到之前的文件版本
   - 从history.json中获取版本变更历史
